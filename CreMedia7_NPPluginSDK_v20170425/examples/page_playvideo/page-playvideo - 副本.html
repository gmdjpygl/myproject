<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
	<title>CreMedia7.0 WebClient Demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="../../js/jquery/jquery-1.9.1.js" type="text/javascript"></script> 
	<script src="../../js/jquery/lib/snippet/jquery.snippet.js" type="text/javascript"></script>
	<script src="../../js/jquery/lib/jquery.json-2.4.js" type="text/javascript"></script> 
    <script src="../../js/NPPInterface.js" type="text/javascript"></script> 
    <script src="../../js/NPPInterlayer.js" type="text/javascript"></script> 
	<script src="../npp_examples_config.js" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" href="../images/pages.css" />	
	<link rel="stylesheet" type="text/css" href="../../js/jquery/lib/snippet/jquery.snippet.css" /> 
	<style>
		table,td,tr{
			border:1px grey solid;
		}
		td{
			width:250px;
		}
		.td_b{
			color:blue;
		}
		input,button{ width:80px;margin-bottom:3px; height:22px;}
	</style>
</head>
<body>
<h1 class="h1A">父页面连接弹窗播放PopWindow</h1>
    <div class="content cc" style="border:0px red solid">
		<p style="text-indent: 2em;font-size:120%;">页面加载完成之后，在主页面进行初始化，创建连接NPPILY.Connect(connParams)，获取资源NPPILY.ForkResource()操作以后就可以播放视频了。播放视频首先需要利用window.open()创建播放窗口，在主页面获取到播放窗口对象直接之后，在播放窗口创建窗口插件。需要在调用播放视频接口之前，先调用NPPILY.CreateWindow接口。该接口会创建窗口插件，返回窗口信息，并记录在NPPILY.Struct.WindowStruct。接着调用播放视频接口NPPILY.PlayVideo,就可以播放视频了。具体请看下面的接口说明。
		</p>
		<p style="text-indent: 2em;padding-top:10px;">
			<strong>
				窗口信息结构 NPPILY.Struct.WindowStruct:
			</strong>
		</p>
		
		<div style="padding-left:25px;padding-top:10px;">
			<table>
				<tr>
					<td>
						变量
					</td>
					<td>
						类型
					</td>
					<td>
						描述
					</td>
				</tr>
				<tr>
					<td class="td_b">
						container
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						窗口容器DOM对象
					</td>
				</tr>
				<tr>
					<td class="td_b">
						containerId
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						窗口容器ID
					</td>
				</tr>
				<tr>
					<td class="td_b">
						wndName
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						窗口插件Name
					</td>
				</tr>
				<tr>
					<td class="td_b">
						wnd
					</td>
					<td>
						Object NOT NULL
					</td>
					<td>
						窗口插件对象
					</td>
				</tr>
				<tr>
					<td class="td_b">
						connectId
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						与服务器连接id
					</td>
				</tr>
				<tr>
					<td class="td_b">
						wndHandle
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						窗口句柄
					</td>
				</tr>
				<tr>
					<td class="td_b">
						type
					</td>
					<td>
						NPPILY.Enum.WindowType NOT NULL
					</td>
					<td>
						窗口类型
					</td>
				</tr>
				<tr>
					<td class="td_b">
						params
					</td>
					<td>
						Object
					</td>
					<td>
						相关视频参数
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">puid</div>
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						设备PUID
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">idx</div>
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						视频资源索引
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">streamType</div>
					</td>
					<td>
						NPPILY.Enum.NrcapStreamType NOT NULL
					</td>
					<td>
						流类型
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">ivStreamHandle</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						视频流句柄
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">iaStreamHandle</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						音频流句柄
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">alg</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						平台转码流编码算法
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">resolution</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						平台转码流分辨率
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">bitRate</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						平台转码流码率
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">frameRate</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						平台转码流帧率
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">speed</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播速度
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">startTime</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播开始时间
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">endTime</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播结束时间
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">fileFullPath</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播文件全路径
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">fileTimeLength</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播文件时长
					</td>
				</tr>
				<tr>
					<td class="td_b">
						status
					</td>
					<td>
						Object
					</td>
					<td>
						视频窗口状态
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">isddrawing</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否使用了ddraw模式
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">recording</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否在本地录像
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">playaudioing</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否在播放音频
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">playvideoing</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否在播放视频
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">playvoding</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否在点播录像
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">isfullscreening</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						视频窗口是否在全屏
					</td>
				</tr>
				<tr>
					<td class="td_b">
						customParams
					</td>
					<td>
						Object NULL
					</td>
					<td>
						自定义参数
					</td>
				</tr>
				<tr>
					<td class="td_b">
						style
					</td>
					<td>
						Object
					</td>
					<td>
						窗口样式<span style="color:red">(未启用)</span>
					</td>
				</tr>
			</table>
		</div>
		<p style="text-indent: 2em;padding-top:10px;">
			<strong>
				窗口事件信息结构 NPPILY.Struct.WindowEventStruct
			</strong>
		</p>
		<div style="padding-left:25px;padding-top:10px;">
			<table>
				<tr>
					<td>
						变量
					</td>
					<td>
						类型
					</td>
					<td>
						描述
					</td>
				</tr>
				<tr>
					<td class="td_b">
						lbtn_click
					</td>
					<td>
						Object({status: true_or_false, callback: function () {...}?}) NULL
					</td>
					<td>
						鼠标左键点击
					</td>
				</tr>
				<tr>
					<td class="td_b">
						select_rect
					</td>
					<td>
						Object({status: true_or_false, callback: function () {...}?}) NULL
					</td>
					<td>
						矩形框选择
					</td>
				</tr>
				<tr>
					<td class="td_b">
						ptz_control
					</td>
					<td>
						Object({status: true_or_false, callback: function () {...}?}) NULL
					</td>
					<td>
						云台控制
					</td>
				</tr>
				<tr>
					<td class="td_b">
						fsw_show
					</td>
					<td>
						Object({status: true_or_false, callback: function () {...}?}) NULL
					</td>
					<td>
						显示全屏（建议status属性值不用设置，因为无论如何双击视频窗口，均会全屏的）
					</td>
				</tr>
				<tr>
					<td class="td_b">
						fsw_hide
					</td>
					<td>
						Object({status: true_or_false, callback: function () {...}?}) NULL
					</td>
					<td>
						关闭全屏
					</td>
				</tr>
				<tr>
					<td class="td_b">
						menu_command
					</td>
					<td>
						Object({status: true_or_false, menu: [{key: ?, text: ?}, ...], callback: function () {...}?}) NULL
					</td>
					<td>
						自定义右键菜单项
					</td>
				</tr>
			</table>
		</div>
		<p style="text-indent: 2em;padding-top:10px;">
			<strong>
				示例：
			</strong>
		</p>
		
		<div style="padding-left:25px;padding-top:10px;overflow:auto;width:785px;border:0px red solid;">
			<div><input type="button" value="获取资源" onclick="WebClient.FetchResource();"/></div>
			<div style="float:left;"><div id="resourceTree" class="resourceTree" ></div></div>
			<div id="loginMsg"></div>
			
            <div style="float:left;padding-left:25px;padding-top:10px;">
                <div><input type="button" value="关闭" onclick="WebClient.ButtonsOperation('stopvideo');"/></div>
                <div><input type="button" value="向上" onmousedown="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.turnup);" onmouseup="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.stopturn);"/></div>
                <div><input type="button" value="向下" onmousedown="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.turndown);" onmouseup="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.stopturn);"/></div>
                <div><input type="button" value="向左" onmousedown="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.turnleft);" onmouseup="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.stopturn);"/></div>
                <div><input type="button" value="向右" onmousedown="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.turnright);" onmouseup="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.stopturn);"/></div>
                <div><input type="button" value="抓拍" onclick="WebClient.ButtonsOperation('localsnapshot');"/></div>
                <div><input type="button" value="录像" onclick="WebClient.ButtonsOperation('localrecord');"/></div>
                <div><input type="button" value="音频" onclick="WebClient.ButtonsOperation('playaudio');"/></div>
                <br />
                <div><input id="opt_call" type="button" value="开启喊话" onclick="WebClient.ButtonsOperation('startCall');"/></div>
                <div><input id="opt_talkback" type="button" value="开启对讲" onclick="WebClient.ButtonsOperation('startTalk');"/></div>
             </div>
		</div>
		
		<p style="text-indent: 2em;padding-top:10px;">
			<strong>
				JavaScript源码：
			</strong>
		</p>
        
		<div style="padding-left:25px;padding-top:10px;overflow:auto;">
			<pre id="preCode" style="border:0px grey solid;width:790px;">
			<code>
	// - 打开子窗口事件
	var popWindow = window.open(url, pageName, ...);
	// - 父页面获取播放窗口中容器对象元素（以下调用要等到popWindow中所有对象或元素加载后）
	var domContainer = popWindow.document.getElementById("idWindowContainer");
    
	// - 添加窗口事件
	var windowAttachEvent = new NPPILY.Struct.WindowEventStruct();
	windowAttachEvent.lbtn_click.status = true;
	windowAttachEvent.lbtn_click.callback = function() {
		// 鼠标左键单击响应回调函数
	}
	windowAttachEvent.select_rect.status = true;
	windowAttachEvent.select_rect.callback = function() {
		/*鼠标拉选响应回调函数,注意在窗口模式为“框选”时有效，
		  回调时callback(x1, y1, x2,y2)，其中(x1,y1)、(x2,y2)
		  分别代表窗口中框选的左上与右下坐标*/
	}
	windowAttachEvent.ptz_control.status = true;
	windowAttachEvent.ptz_control.callback = function() {
		// 窗口云台控制响应回调函数，内部会自行处理云台控制，上层不需要发控制命令
	}
    // fsw_show.status | fsw_hide.status置为false没有意义，造成全屏黑屏
	windowAttachEvent.fsw_show.status = true;
	windowAttachEvent.fsw_show.callback = function() {
		// 窗口全屏后的回调函数
	}
	windowAttachEvent.fsw_hide.status = true;
	windowAttachEvent.fsw_hide.callback = function() {
		// 窗口全屏恢复后的回调函数
	}
    // 自定义视频窗口右键菜单项
    windowAttachEvent.menu_command.status = true;
    windowAttachEvent.menu_command.menu = [{
        key: "stopvideo", text: "停止视频"							
    }, {
        key: "playaudio", text: "播放音频"
    }, {
        key: "localsnapshot", text: "本地抓拍"
    }, {
        key: "localrecord", text: "开启本地录像"
    }, {
        key: "separator", text: "first"							
    }, {
        key: "fullscreen", text: "全屏"		
    }];
    windowAttachEvent.menu_command.callback = function (menukey) {
        // 选择右键菜单项回调，menukey对应上面的key，如menukey == "stopvideo"
    };
	
	// - 在播放视频之前，应先调用创建窗口
	var opeator = NPPILY.CreateWindow(connectId, domContainer, NPPILY.Enum.NrcapStreamType.REALTIME, windowAttachEvent);
	if(opeator.rv == NrcapError.NRCAP_SUCCESS){
		// wnd为窗口信息，应该记录到NPPILY.WindowContianers中
		var wnd = operator.response;
		// 播放视频
		var play_operator = NPPILY.PlayVideo(connectId, wnd, puid, idx, NPPILY.Enum.NrcapStreamType.REALTIME);
		if(play_operator.rv == NrcapError.NRCAP_SUCCESS) {
			// 播放成功
		}
	}
	</code>
			</pre>
		</div>
		
	</div>	
</body>
</html>

<script type="text/javascript">

var WebClient = {
	connectId: null,
	resource: new NPPUtils.Hash(),
	
	Load: function () {
		try {
			$.browser = {};
			
			$("#preCode").snippet("javascript", {style: "acid", collapse: true, startCollapsed: false});
			
			// 首先初始化NPPILY，加载插件
			var operator = NPPILY.Init(new NPPILY.Struct.InitParamStruct(false, null, null));
			if (operator.rv != 0) {
				// 初始化不成功
				alert(NrcapError.Detail(operator.rv));
			}
			
			// 建立连接
			WebClient.Connect();
		}
		catch (e) {
			alert("excep error -> " + e.name + "::" + e.message);
			return false;
		}
	},
	
	UnLoad: function () {
		// 关闭所有的弹窗
		WebClient.ClosePopWindow("closeAll");
		
		NPPILY.UnLoad();
	},
	
	// - 创建连接，连接信息记录在NPPILY.Connections全局变量中
	Connect: function() {
		var path = _npc.connParams.path || "127.0.0.1:8866";
		var username = _npc.connParams.username || "admin";
		var password = _npc.connParams.password || "";
		var epId = _npc.connParams.epId || "system"; //登陆参数：企业id
		var bfix = _npc.connParams.bfix || 0;
		
		// 调用建立连接函数
		var operator = NPPILY.Connect
		(
			new NPPILY.Struct.ConnParamStruct
			(
				path,
				username,
				epId,
				password,
				bfix
			)　
		);
		if (operator.rv == 0) {
			// 此即是当前连接ID，记录下来
			WebClient.connectId = operator.response;
			
			// 注册绑定NC事件回调，所有的视频状态、喊话对讲、音频状态等信息都是通过回调通知
			NPPILY.NCNotifyManager.Add(
				NPPILY.Enum.NCObjectNotify.stream_status_notify,
				function (notify) {
					// 更新视频状态回调，等有视频播放的时候就会有调用
					WebClient.UpdateVideoStatus(notify);
				}
			);
		}
		else {
			if ($("#loginMsg").get(0)) {
				$("#loginMsg").html(NrcapError.Detail(operator.rv) + "<br />");
			}
		}
	},
	/*	
		获取资源(FetchResource)
		connectId(string) 连接ID
		forkLevel(NPPILY.Enum.ForkResourceLevel) 构建资源级别
		offset(uint) 分页查询开始索引
		count(unit) 分页查询每次最大个数
	*/
	FetchResource: function () {
		try {
			var connectId = WebClient.connectId;
			if (!connectId || !NPPILY.Connections.get(connectId)) {
				alert("连接信息不存在，获取资源失败");
				return false;
			}
			var _connStruct = NPPILY.Connections.get(connectId),
				rootName = "",
				resource = [],
				style = "cr",
				offset = 0,
				count = 200,
				html = [];
			
			if (_connStruct.connType == NPPILY.Enum.ConnectionType.Server) {
				rootName = _connStruct.systemName || "网络视频监控系统";
				
				while(true) {
					// 分页获取所有设备资源
					var operator = NPPILY.ForkResource
					(
						connectId,
						NPPILY.Enum.ForkResourceLevel.nppForkPUInfo,
						offset,
						count,
						"" // 为空获取根平台的资源 
					);
					if (operator.rv == 0 && operator.response) {
						resource = resource.concat(operator.response);
						
						if (operator.response.length >= count) {
							// 继续获取
							offset = offset + count;
						}
						else {
							break;
						}
					}
					else {
						// 其他错误跳出循环
						break;
					} 
				};
				
				// 进行在线排序
				var onlines = [], offlines = [];
				$.each(resource, function (index, item) {
					if (item.online == 1 && item.enable == 1) {
						onlines.push(item);
					}
					else {
						offlines.push(item);
					}
				});
				resource = [];
				resource = resource.concat(onlines);
				resource = resource.concat(offlines);
			}
			else {
				// 直连设备
				var operator = NPPILY.ForkResource(connectId);
				if (operator.rv == 0 && operator.response) {
					resource = [operator.response];
					
					rootName = operator.response.name || "";
				}
			}
			// 记录资源信息
			WebClient.resource.set(connectId, resource);
			
			if ($("#resourceTree")[0]) {
				var lastnode = "",
					idRootPfx = style + '_cesSystemManagement';
				
				html.push('<div id="' + idRootPfx + '" style="white-space:nowrap;margin-top:2px !important; margin-top:2px;">');
					html.push('<input id="'+idRootPfx+'_img_title" type="button" class="minus" onfocus="this.blur();" onclick="WebClient.Expandsion($(\'#'+idRootPfx+'_childresourcebox\')[0], $(\'#'+idRootPfx+'_img_title\')[0]);" />');
					html.push('<input id="'+idRootPfx+'_img_ico" type="button" class="root" onfocus="this.blur();" onclick="WebClient.Expandsion($(\'#'+idRootPfx+'_childresourcebox\')[0], $(\'#'+idRootPfx+'_img_title\')[0]);" />');
					html.push('<label onclick="WebClient.Expandsion($(\'#'+idRootPfx+'_childresourcebox\')[0],$(\'#'+idRootPfx+'_img_title\')[0]);" title="'+rootName+'">'+rootName+'</label>');
					// html.push('<a href="javascript:void(0);" onclick="WebClient.Expandsion($(\'#'+idRootPfx+'_childresourcebox\')[0], $(\'#'+idRootPfx+'_img_title\')[0]);" title="' + rootName + '">' + rootName + '</a>');
				html.push('</div>');
				
				html.push('<div id="'+idRootPfx+'_childresourcebox" class="childresourcebox_blankline" style="padding-left:15px;">');
				// 遍历资源
				$.each(resource, function (index, item) {
					var prefix = "station", suffix = "_disabled", idPfx = style + "_" + item.puid;
					
					if (_connStruct.connType == NPPILY.Enum.ConnectionType.Server) {
						switch (item.modelType) {
							case NPPILY.Enum.PuModelType.ENC:
								prefix = "station";
								break;
							case NPPILY.Enum.PuModelType.WENC:
								prefix = "gateway";
								break;
							default:
								return true;
								break;
						}
					}
					
					if (item.online == 1 && item.enable == 1) {
						suffix = "";
					}
					var clsname = prefix + "" + suffix;
					
					html.push('<div style="white-space:nowrap;">');
						html.push('<input id="'+idPfx+'_img_title" type="button" class="plus" onfocus="this.blur();" onclick="WebClient.FetchChildResource(\'' + item.puid + '\', \'' + style + '\');" />');
						html.push('<input id="'+idPfx+'_img_ico" type="button" class="'+clsname+'" onfocus="this.blur();" onclick="WebClient.FetchChildResource(\'' + item.puid + '\', \'' + style + '\');" />');
						html.push('<label onclick="WebClient.FetchChildResource(\'' + item.puid + '\', \'' + style + '\');" title="'+item.name+'">'+item.name+'</label>');
						// html.push('<a href="javascript:void(0);" onclick="WebClient.FetchChildResource(\'' + item.puid + '\', \'' + style + '\');" title="' + item.name + '">' + item.name + '</a>');
					html.push('</div>');
					html.push('<div id="'+idPfx+'_childresourcebox" class="childresourcebox_directline" style="height:auto;display:none;padding-left:15px;">');
					html.push('</div>');
					
					lastnode = idPfx + '_childresourcebox';
				});
				if (resource.length <= 0) {
					html.push('<div style="font-style:italic;">（无设备资源）</div>');
				}
				html.push('</div>');
				
				$("#resourceTree")
					.html(html.join(""))
					.find("#" + lastnode)
					.attr("class", "childresourcebox_blankline");
			}
		}
		catch (e) {
			alert("excep error -> " + e.name + "::" + e.message);
			return false;
		}
	},
	
	/*获取子资源(FetchChildResource)
	  puid(string) 设备PUID
	  connectId(string) 连接ID
	  forkLevel(NPPILY.Enum.ForkResourceLevel.nppForkPUResourceInfo) 构建资源级别
	*/
	FetchChildResource: function (puid, style) {
		try {
			var idPfx = style + "_" + puid,
				idChildresbox = idPfx + "_childresourcebox",
				idPUTitle = idPfx + "_img_title";
			
			var connectId = WebClient.connectId;
			if (!connectId || !NPPILY.Connections.get(connectId)) {
				alert("连接信息不存在，获取资源失败");
				return false;
			}
			var _connStruct = NPPILY.Connections.get(connectId);
			
			if ($("#" + idChildresbox)[0]) {
				if ($("#" + idChildresbox).html() == "") {
					// 是否存在相关子资源信息
					var puInfo, puChildres = [];
					$.each(WebClient.resource.get(connectId), function(index, item) {
						if (item.puid == puid) {
							puInfo = item;
							puChildres = item.childResource || [];
							return false;
						}
					});
					// 为空就去获取子资源信息
					if (!puChildres || puChildres.length <= 0) {
						var operator = NPPILY.ForkResource
						(
							connectId,
							NPPILY.Enum.ForkResourceLevel.nppForkPUResourceInfo,
							null,
							null,
							null,
							{
								PUID: puid
							}
						);
						if (operator.rv == 0) {
							puChildres = operator.response;
						}
					}
					
					var html = [],
						lastnode = "";
					
					if (puInfo && puChildres && puChildres.length > 0) {
						$.each(puChildres, function (index, item) {
							var prefix = "inputvideo", suffix = "";
							
							if (item.type != NPPILY.Enum.PuResourceType.VideoIn) {
								return true;
							}
							
							if (puInfo.online == 0 || puInfo.enable == 0 || item.enable == 0) {
								suffix = "_disabled";
							}
							
							var clsname = prefix + "" + suffix;
							
							var idChildPfx = idPfx + "_" + item.type + "_" + item.idx;
							
							html.push('<div style="white-space:nowrap;">');
								html.push('<input id="'+idChildPfx+'_img_title" type="button" class="outline" onfocus="this.blur();" onclick="WebClient.treeCallBack(\'' + puid + '\',\'' + item.idx + '\',\'' + style + '\',\'' + item.name + '\');" />');
								html.push('<input id="'+idChildPfx+'_img_ico" type="button" class="'+clsname+'" onfocus="this.blur();" onclick="WebClient.treeCallBack(\'' + puid + '\',\'' + item.idx + '\',\'' + style + '\',\'' + item.name + '\');" />');
								html.push('<label onclick="WebClient.treeCallBack(\'' + puid + '\',\'' + item.idx + '\',\'' + style + '\',\'' + item.name + '\');" title="'+item.name+'">'+item.name+'</label>');
								// html.push('<a href="javascript:void(0);" onclick="WebClient.treeCallBack(\'' + puid + '\',\'' + item.idx + '\',\'' + style + '\',\'' + item.name + '\');" title="' + item.name + '">' + item.name + '</a>');
							html.push('</div>');
							
							lastnode = idChildPfx + "_img_title";
						});
					}
					else {
						html.push('<div style="font-style:italic;">（无视频资源）</div>');
					}
					
					$("#" + idChildresbox)
						.html(html.join(""))
						.find("#" + lastnode)
						.attr("class", "endline");
						
				} // end if html()
				
				WebClient.Expandsion($("#" + idChildresbox)[0], $("#" + idPUTitle)[0]);
			} 
		}
		catch (e) {
			alert("excep error -> " + e.name + "::" + e.message);
			return false;
		}
	},
	
	// 视频播放树回调 
	treeCallBack: function (puid, idx, type, name) {
		try {
			var url = "playwindow.html?time="+new Date().getTime(),
				pageName = "playwindow_" + puid + "_" + idx,
				isExists = false;
			
			// 先判断有没有同一视频窗口在播放了
			NPPILY.WindowContainers.each(function (item) {
				if(item.key == pageName) {
					isExists = true;
					item.value.popWindow.focus();
					
					// 如果存在窗口但是视频时关闭的就重新打开
					if (item.value.window && !item.value.window.status.playvideoing) {
						// 呼出视频播放
						WebClient.PlayVideo(item.value.popWindowInfo.puid, item.value.popWindowInfo.idx, item.value.popWindowInfo.name);
					}
					
					// 激活选择窗口
					WebClient.SelectPopWindow(item.value.popWindowInfo.pageName);
					return true;
				}
			});
			if (isExists == true) {
				// alert("已经存在同一视频播放");
				return false;
			}
			
			// 呼出一个弹窗
			var popWindow = window.open(url, pageName, "width=450,height=350,top=300,left=600,resizable=no,toolbar=no,menubar=no,scrollbars=no,location=no,status=no");
			
			if (typeof popWindow == "object") {
				var winNoder = new NPPILY.Struct.WindowContainerStruct(
					popWindow, // 代表一个window.open对象
					NPPILY.Enum.WindowType.VIDEO,
					true,
					null,
					null
				);
				winNoder.inited = false; // popWindow是否加载完成
				winNoder.popWindow = popWindow;
				winNoder.popWindowInfo = {
					pageName: pageName,
					puid: puid,
					idx: idx,
					type: type,
					name: name
				};
				
				// 存到窗口信息容器中
				NPPILY.WindowContainers.set(pageName, winNoder);
				
				// 由于呼出一个弹窗，所属的元素可能还没有就绪无法使用，故需要轮询一下
				if (!NPPUtils.Timer.ContainsKey("loading", "popwindow")) {
					// 开启总的轮询
					NPPUtils.Timer.Start();
					NPPUtils.Timer.Set(
						"loading", {
							name: "popwindow",
							fu: function () {
								var complete = true;
								NPPILY.WindowContainers.each(function (item) {
									var node = item.value;
									if (node && !node.inited) {
										complete = false;
										if (node.popWindow && node.popWindow.document.getElementById("windowbox")) {
											// popWindow加载完成
											node.inited = true;
											
											node.popWindow._popWindowInfo = node.popWindowInfo;
											
											// 注册退出事件
											$(node.popWindow).unload(function () {
												if (this._popWindowInfo && this._popWindowInfo.pageName) {
													WebClient.ClosePopWindow("closeOne", this._popWindowInfo.pageName);
												}
											});
											
											// 呼出视频播放
											WebClient.PlayVideo(node.popWindowInfo.puid, node.popWindowInfo.idx, node.popWindowInfo.name);
											
											// 激活选择窗口
											WebClient.SelectPopWindow(node.popWindowInfo.pageName);
										}
									} 
								});
								if (complete) {
									// 移除popwindow子轮询
									NPPUtils.Timer.UnSet("loading", "popwindow");
								}
							},
							interval: 200
						}
					);
				}
			} 
		}
		catch (e) {
			alert("excep error -> " + e.name + "::" + e.message);
			return false;
		}
	},
	// 关闭弹窗
	ClosePopWindow: function (action, pageName) {
		try {
			var action = action || "closeAll";
			
			NPPILY.WindowContainers.each(function (item) {
				var node = item.value;
				if (action == "closeAll" || (action == "closeOne" && item.key == pageName)) {
					// 停止视频
					WebClient.StopVideo(pageName);
					
					if (node.popWindow && !node.popWindow.closed && typeof node.popWindow.close != "undefined") {
						node.popWindow.close();
					}
					// 移除信息
					NPPILY.WindowContainers.unset(item.key);
				}
			});
		}
		catch (e) {
			alert("excep error -> " + e.name + "::" + e.message);
			return false;
		}
	},
	
	// 播放视频
	PlayVideo: function (puid, idx, name) {
		try {
			// 弹窗名称
			var pageName = "playwindow_" + puid + "_" + idx;
			
			NPPILY.WindowContainers.each(function (item) {
				var node = item.value;
				if (item.key == pageName) {
					var create = true;
					if (node.window) {
						create = false;
						
						if (node.window.status.playvideoing) {
							// 停止视频
							WebClient.StopVideo(item.key);
						}
					}
					if (create) {
						var winevt = new NPPILY.Struct.WindowEventStruct();
						// 单击事件
						winevt.lbtn_click.status = true;
						winevt.lbtn_click.callback = function () {
							WebClient.ResponseOperation("SelectPopWindow", item.key);
						};
						// 视频窗口（退出）全屏回调
						winevt.fsw_show.callback = winevt.fsw_hide.callback = function () {
							WebClient.ResponseOperation("BackFullScreen", item.key);
						};
						// 窗口内云台控制允许
						winevt.ptz_control.status = true;
						// 右键菜单
						winevt.menu_command.status = true;
						winevt.menu_command.menu = [{
							key: "stopvideo", text: "停止视频"							
						}, {
							key: "playaudio", text: "播放音频"
						}, {
							key: "localsnapshot", text: "本地抓拍"
						}, {
							key: "localrecord", text: "开启本地录像"
						}, {
							key: "separator", text: "first"							
						}, {
							key: "fullscreen", text: "全屏"		
						}];
						winevt.menu_command.callback = function (menukey) {
							WebClient.ResponseOperation("menu_command", item.key, menukey);
						};
						
						// - 创建窗口
						var win_operator = NPPILY.CreateWindow
						(
							WebClient.connectId,
							node.popWindow.document.getElementById("windowbox"), // 注意应该是弹窗中的元素
							NPPILY.Enum.WindowType.VIDEO,
							winevt
						);
						if (win_operator.rv == 0) {
							node.window = win_operator.response;
						}
						else {
							alert("创建窗口失败 -> " + NrcapError.Detail(win_operator.rv));
						}
					} // end create
					
					// 播放视频
					var operator = NPPILY.PlayVideo
					(
						WebClient.connectId,
						node.window,
						puid,
						idx,
						NPPILY.Enum.NrcapStreamType.REALTIME // 这里默认播放实时流
					);
					if (operator.rv != 0) {
						alert("播放视频失败 -> " + NrcapError.Detail(operator.rv));
					}
					else {
						// 视频名称
						node.window.customParams.ivName = name;
						
						// 把视频插件宽高置为100%自适应窗口容器
						NPPILY.ResizeWindowDimension(node.window, "100%", "100%");
					}
				}
			});
		}
		catch (e) {
			alert("excep error -> " + e.name + "::" + e.message);
			return false;
		}
	},
	 // 响应窗口回调
	ResponseOperation: function (action, pageName) {
		try {
			var node = NPPILY.WindowContainers.get(pageName);
			
			var domContainer = node.popWindow.document.getElementById("windowbox"),
				domTitle = node.popWindow.document.getElementById("windowtitle"),
				domLoginMsg = node.popWindow.document.getElementById("loginMsg");
			 	
			switch (action) {
				case "SelectPopWindow":
					$(domLoginMsg).html("鼠标单击窗口回调");
					
					// 激活窗口
					WebClient.SelectPopWindow(pageName);
					break;
				case "BackFullScreen":
					// （退出）全屏回调
					$(domLoginMsg).html("视频窗口（退出）全屏回调");
					WebClient.BackFullScreen(pageName);
					break;
				case "menu_command":
						
					$(domLoginMsg).html("点击窗口右键菜单项回调");
							
					// 右键菜单项回调
					var menuKey = arguments[2];
					switch (menuKey) {
						case "stopvideo": // 停止视频
							WebClient.StopVideo(pageName);
							// WebClient.ClosePopWindow("closeOne", pageName);
							break;
						case "playaudio": // 播放/停止音频
							WebClient.PlayAudio(pageName);
							break;
						case "localsnapshot": // 本地抓拍
							WebClient.LocalSnapshot(pageName);
							break;
						case "localrecord": // 本地录像
							WebClient.LocalRecord(pageName);
							break;
						case "fullscreen": // （退出）全屏
							WebClient.FullScreen(pageName);
							break;
					};
					break;
			};
		}
		catch (e) {
			alert("excep error = " + e.name + "::" + e.message);
			return false;
		}
	},
	// 选择弹出的窗口
	SelectPopWindow: function (pageName) {
		try {
			NPPILY.WindowContainers.each(function (item) {
				var node = item.value;
				if (item.key == pageName) {
					if (node && node.popWindow && node.popWindow.document) {
						node.popWindow.document.body.style.backgroundColor = "#CCCCCC";	
					}
					WebClient.curActivepageName = pageName;		
					
					// 更新喊话对讲按钮状态
					WebClient.UpdateCallTalkButtonStatus(pageName);		
				}
				else {
					if (node && node.popWindow && node.popWindow.document) {
						node.popWindow.document.body.style.backgroundColor = "";	
					}	
				}
			});
		}
		catch (e) {
			alert("excep error = " + e.name + "::" + e.message);
			return false;
		}
	},
	// 响应（退出）全屏事件
	BackFullScreen: function (pageName) {
		try {
			if (pageName && NPPILY.WindowContainers.get(pageName)) {
				var node = NPPILY.WindowContainers.get(pageName);
				if (node.window) {
					var customMenus = [];
					if (node.window.status.isfullscreening) {
						customMenus.push({key: "fullscreen", text: "退出全屏"});
					}
					else {
						customMenus.push({key: "fullscreen", text: "全屏"});
					}
					// 更新菜单项
					NPPILY.WindowAttachEvent.UpdateMenuCommand(node.window, customMenus);
				}
			}
		}
		catch (e) {
			alert("excep error = " + e.name + "::" + e.message);
			return false;
		}
	},
	
	// 停止视频
	StopVideo: function (pageName) {
		try {
			if (pageName && NPPILY.WindowContainers.get(pageName)) {
				var node = NPPILY.WindowContainers.get(pageName);
				if (node.window) {
					var puid = node.window.params.puid;
					
					// 把设备的喊话对讲先给停止了
					NPPILY.CallTalkControl.Stop(WebClient.connectId, puid, 0);
					// 更新喊话对讲按钮状态
					WebClient.UpdateCallTalkButtonStatus(pageName);
					
					// 然后停止视频
					var ivStreamHandle = node.window.params.ivStreamHandle;
					NPPILY.StopVideo(node.window);
					// 把视频插件宽高置为0，注意本身及其所有祖先容器不可设置成隐藏（尤其在非IE浏览器中）
					NPPILY.ResizeWindowDimension(node.window, 0, 0);
					
					var domContainer = node.popWindow.document.getElementById("windowbox"),
						domTitle = node.popWindow.document.getElementById("windowtitle"),
						domLoginMsg = node.popWindow.document.getElementById("loginMsg");
					
					$(domTitle).html("&nbsp;无视频");
					$(domLoginMsg).html();
				}
			}
		}
		catch (e) {
			alert("excep error = " + e.name + "::" + e.message);
			return false;
		}
	},
	
	// 播放/关闭音频
	PlayAudio: function (pageName) {
		try {
			var fn = "WebClient.PlayAudio";
			
			NPPILY.WindowContainers.each(function(item) {
				if (item.key == pageName) {
					NPPILY.PlayAudio(item.value.window);
					
					// 更新菜单项
					if (item.value.window.status.playvideoing) {
						var customMenus = [];
						if (item.value.window.status.playaudioing) {
							customMenus.push({key: "playaudio", text: "停止音频"});
						}
						else {
							customMenus.push({key: "playaudio", text: "播放音频"});
						}
						NPPILY.WindowAttachEvent.UpdateMenuCommand(item.value.window, customMenus);
					}
				}
			});
		}
		catch (e) {
		}
	},
	// 本地抓拍
	LocalSnapshot: function (pageName) {
		try {
			var fn = "WebClient.LocalSnapshot";
			
			NPPILY.WindowContainers.each(function(item) {
				if (item.key == pageName) {
					NPPILY.Snapshot(item.value.window, "C:/"); // 默认存放在C盘
				}
			});
		}
		catch (e) {
			alert("excep error = " + e.name + "::" + e.message);
			return false;
		}
	},
	// 本地录像
	LocalRecord: function (pageName) {
		try {
			var fn = "WebClient.LocalRecord";
			
			NPPILY.WindowContainers.each(function(item) {
				if (item.key == pageName) {
					NPPILY.LocalRecord(item.value.window, "C:/"); // 默认存放在C盘
					
					// 更新菜单项
					if (item.value.window.status.playvideoing) {
						var customMenus = [];
						if (item.value.window.status.recording) {
							customMenus.push({key: "localrecord", text: "停止本地录像"});
						}
						else {
							customMenus.push({key: "localrecord", text: "开启本地录像"});
						}
						NPPILY.WindowAttachEvent.UpdateMenuCommand(item.value.window, customMenus);
					}
				}
			});
		}
		catch (e) {
			alert("excep error = " + e.name + "::" + e.message);
			return false;
		}
	},
	// （退出）全屏
	FullScreen: function (pageName) {
		try {
			var fn = "WebClient.FullScreen";
			
			NPPILY.WindowContainers.each(function(item) {
				if (item.key == pageName) {
					if (item.value.window.status.playvideoing) {
						if (item.value.window.status.isfullscreening) {
							NPPILY.ExitFullScreen(item.value.window); // 退出全屏
						}
						else {
							NPPILY.FullScreen(item.value.window); // 全屏
						}
					}
				}
			});
		}
		catch (e) {
			alert("excep error = " + e.name + "::" + e.message);
			return false;
		}
	},
	
	// 更新视频状态
	UpdateVideoStatus: function (notify) {
		try {
			if (notify && notify._HANDLE) {
				NPPILY.WindowContainers.each(function (item) {
					var node = item.value;
					if (node.window && node.window.status.playvideoing) {
						// 根据句柄匹配
						if (node.window.params.ivStreamHandle == notify._HANDLE) {
							 if (notify.errorCode == 0) {
								if (notify.status == -1) {
									// 流断开，必要时去重新播放视频，这里不做处理了，请自行处理
									return false;
								}
								
								var html = [];
								// 视频名称
								html.push(node.window.customParams.ivName);
								if (typeof notify.statusDesc != "undefined" && notify.statusDesc != "") {
									html.push("&nbsp;");
									html.push(notify.statusDesc);
								}
								html.push(",帧率=" + (notify.keyData.frame_rate || 0));
								html.push(",码率=" + ((notify.keyData.bit_rate || 0)/1000).toFixed(0) + "kb");
								
								if (node.window.status.playaudioing) {
									html.push(",正在播放声音");
								}
								if (node.window.status.recording) {
									html.push(",正在录像");
								}
								// 是否有喊话对讲
								var oaStatus_operator = NPPILY.CallTalkControl.GetStatus(WebClient.connectId, node.window.params.puid, 0);
								if (oaStatus_operator.rv == 0) {
									var oaStatus = oaStatus_operator.response;
									if (oaStatus && oaStatus.oaStreamHandle) {
										html.push(",正在" + (oaStatus.call ? "喊话" : "对讲"));
									}
								}
								
								if (node.popWindow) {
									$(node.popWindow.document.getElementById("windowtitle"))
										.html(html.join(""))
										.attr("title", html.join("").replace(/(\&nbsp;)/gm, ""));
								}
							} // end errorCode
						}
					}
				});
			}
		}
		catch (e) {
			// alert("excep error -> " + e.name + "::" + e.message);
			return false;
		}
	},
	
	/*
	---
	desc: 视频窗口区域右侧按钮操作
	remark:
		<div><input type="button" value="关闭" onclick="WebClient.ButtonsOperation('stopvideo');"/></div>
		<div><input type="button" value="向上" onmousedown="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.turnup);" onmouseup="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.stopturn);"/></div>
		<div><input type="button" value="向下" onmousedown="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.turndown);" onmouseup="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.stopturn);"/></div>
		<div><input type="button" value="向左" onmousedown="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.turnleft);" onmouseup="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.stopturn);"/></div>
		<div><input type="button" value="向右" onmousedown="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.turnright);" onmouseup="WebClient.ButtonsOperation('ptzcontrol', NPPIF.Enum.PTZDirection.stopturn);"/></div>
		<div><input type="button" value="抓拍" onclick="WebClient.ButtonsOperation('localsnapshot');"/></div>
		<div><input type="button" value="录像" onclick="WebClient.ButtonsOperation('localrecord');"/></div>
		<div><input type="button" value="音频" onclick="WebClient.ButtonsOperation('playaudio');"/></div>
		<br />
		<div><input id="opt_call" type="button" value="开启喊话" onclick="WebClient.ButtonsOperation('startCall');"/></div>
		<div><input id="opt_talkback" type="button" value="开启对讲" onclick="WebClient.ButtonsOperation('startTalk');"/></div>
	...
	*/
	ButtonsOperation: function (action) {
		try {
			var fn = "WebClient.ButtonsOperation",
				curpageName = WebClient.curActivepageName;
				
			switch (action) {
				case "stopvideo": // 停止视频
					// WebClient.StopVideo(curpageName);
					WebClient.ClosePopWindow("closeOne", curpageName);
					break;
				case "playaudio": // 播放/停止音频
					WebClient.PlayAudio(curpageName);
					break;
				case "localsnapshot": // 本地抓拍
					WebClient.LocalSnapshot(curpageName);
					break;
				case "localrecord": // 本地录像
					WebClient.LocalRecord(curpageName);
					break;
				case "ptzcontrol": // 云台控制
					WebClient.PTZControl(curpageName, arguments[1]);
					break;
				
				case "startCall":
				case "startTalk":
					WebClient.CallTalkControl(curpageName, action);
					break;
			};
		}
		catch (e) {
			return false;
		}
	},
	
	// 云台控制
	PTZControl: function (pageName, mode) {
		try {
			if (pageName && mode && NPPILY.WindowContainers.get(pageName)) {
				var node = NPPILY.WindowContainers.get(pageName);
				if (node.window && node.window.status.playvideoing) {
					var puid = node.window.params.puid,
						ptz_idx = node.window.params.idx; // 云台资源基本上与视频资源一一对应的，这里先不进行判断是否有云台资源
						
					var operator = NPPILY.PTZ.Control(WebClient.connectId, puid, ptz_idx, mode);
					if (operator.rv != 0) {
						alert("操作云台失败，错误码：" + operator.rv);
					} 
				}
			}
		}
		catch (e) {
			return false;
		}
	},
	// 喊话或对讲控制
	CallTalkControl: function (pageName, action) {
		try {
			if (pageName && NPPILY.WindowContainers.get(pageName)) {
				var node = NPPILY.WindowContainers.get(pageName);
				if (node.window && node.window.status.playvideoing) {
					// 喊话对讲针对的是设备层面，与具体的视频资源没有关系，不应搞对应
					// 这里音频输出资源索引，一般情况下为0，这里没有去判断是否具有音频输出资源，自行判断
					var puid = node.window.params.puid,
						oa_idx = 0; 
						
					// 判断是否处在喊话对讲中
					var oaStatus_operator = NPPILY.CallTalkControl.GetStatus(WebClient.connectId, puid, oa_idx);
					if (oaStatus_operator.rv == 0) {
						var oaStatus = oaStatus_operator.response;
						if (oaStatus) {
						 	// 如果喊话对讲句柄存在，那么就处在喊话对讲中
							if (oaStatus.oaStreamHandle) {
								var needStop = false;
								// 如果是同一按钮操作的就应该停止
								if ((oaStatus.call && action == "startCall") || (oaStatus.talk && action == "startTalk")) {
									needStop = true;
								}
								if (needStop) {
									// 停止喊话对讲
									NPPILY.CallTalkControl.Stop(WebClient.connectId, puid, oa_idx);
								}
								else {
									alert("同一个设备的喊话对讲应该互斥操作");
									return false;
								}
							}
							else {
								var operator = null;
								if (action == "startCall") {
									// 开启喊话
									operator = NPPILY.CallTalkControl.StartCall(WebClient.connectId, puid, oa_idx);
								}
								else {
									// 开启对讲
									operator = NPPILY.CallTalkControl.StartTalk(WebClient.connectId, puid, oa_idx);
								}
								if (operator.rv != 0) {
									alert("喊话对讲失败 ->" + NrcapError.Detail(operator.rv));
								}
							}
							
							// 更新喊话对讲按钮状态
							WebClient.UpdateCallTalkButtonStatus(pageName);
						} 
					} 
					else {
						// 可能不支持喊话或对讲，也可能需要稍候重试即可
						alert("获取喊话对讲状态失败 ->" + NrcapError.Detail(oaStatus_operator.rv));
					}
				} 
			} 
		}
		catch (e) {
			return false;
		}
	},
	// 更新喊话对讲按钮状态
	UpdateCallTalkButtonStatus: function (pageName) {
		try {
			if (pageName && NPPILY.WindowContainers.get(pageName)) {
				var node = NPPILY.WindowContainers.get(pageName);
				if (node.window && node.window.status.playvideoing) {
					var puid = node.window.params.puid,
						oa_idx = 0; 
					var oaStatus_operator = NPPILY.CallTalkControl.GetStatus(WebClient.connectId, puid, oa_idx);
					if (oaStatus_operator.rv == 0) {
						var oaStatus = oaStatus_operator.response;
						if (oaStatus && oaStatus.oaStreamHandle) {
							if (oaStatus.call) {
								$("#opt_call").val("停止喊话");
							}
							else {
								$("#opt_call").val("开启喊话");
							}
							if (oaStatus.talk) {
								$("#opt_talkback").val("停止对讲");
							}
							else {
								$("#opt_talkback").val("开启对讲");
							}
							return false;
						}
					}
				}
				// 其他情况
				$("#opt_call").val("开启喊话");
				$("#opt_talkback").val("开启对讲");
			} 
		}
		catch (e) {
			return false;
		}
	},
	
	//////
	
	// 列表控制
	Expandsion: function (obj, title, ico) {
		if (obj) {
			if (obj.style.display == "none") {
				if (obj.innerHTML == "") return;
				obj.style.display = "block";
				if (title) title.className = "minus";
				if (ico) {
					ico.className = "stationmodel_expand";
				}
			}
			else {
				obj.style.display = "none";
				if (title) title.className = "plus";
				if (ico) {
					ico.className = "stationmodel_collapse";
				}
			}
		}
	},
	
	end: true
};

$(document).ready(function () {
	WebClient.Load();
});
$(window).unload(function () {
	WebClient.UnLoad();
});
if (window.attachEvent) {
	window.attachEvent(
		"onbeforeunload",
		function() {
			WebClient.UnLoad(); 
		}
	);
}
else {
	window.addEventListener (
        "beforeunload",
        function() {
             WebClient.UnLoad();
        },
        false
    );
}
</script>