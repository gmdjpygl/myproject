<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Surveillance 7.0 WebClient 使用帮助</title>

	<script src="../../js/jquery/jquery-1.9.1.js" type="text/javascript"></script> 
	<script src="../../js/jquery/lib/snippet/jquery.snippet.js" type="text/javascript"></script>
	<script src="../../js/jquery/lib/jquery.json-2.4.js" type="text/javascript"></script> 
    <script src="../../js/NPPInterface.js" type="text/javascript"></script> 
    <script src="../../js/NPPInterlayer.js" type="text/javascript"></script> 
    <script type="text/javascript" src="../../js/jquery/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/jquery/easyui/locale/easyui-lang-zh_CN.js"></script>
	<script src="../npp_examples_config.js" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" href="../images/pages.css" />	
	<link rel="stylesheet" type="text/css" href="../../js/jquery/lib/snippet/jquery.snippet.css" />
	<link rel="stylesheet" type="text/css" href="../../js/jquery/easyui/themes/material/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../js/jquery/easyui/themes/icon.css"> 
	<link rel="stylesheet" type="text/css" href="css/style.css">


<!--[if ie]>
<style>
#menubar,#content{ height:100%; top:0; bottom:0; border-top:80px solid #fff; z-index:0}
</style><![endif]-->
	<style type="text/css">
		body{
			font-size:12px;
			overflow: auto;
		}
		td{border:1px solid grey;text-align: center;}
		.tb_head{
			font-size: 14px;
			font-weight: bold;
			color:black;
		}
		a:hover{
			color:blue;
		}
	</style>
</head>

<body>
	<h1 class="h1A">播放视频 NPPILY.PlayVideo</h1>
    <div class="content cc">
		<p style="text-indent: 2em;font-size:120%">当页面加载完成，获取过资源之后，就可以查询录像和存储图片信息。播放视频首先需要创建窗口插件。需要在调用播放视频接口之前，先调用NPPILY.CreateWindow接口，该接口会创建窗口插件，返回窗口信息，并记录在NPPILY.Struct.WindowStruct。接着通过传入设备信息及cuspuid等，通过NPPILY.FetchCSUIVDate获取平台存储下有存储文件的日期，查询到日期后再通过NPPILY.FetchCSUIVDateFiles按日期获取视频的平台存储文件，查询到文件之后可进行播放、下载等操作。具体请看下面的接口说明。
		</p>
		<p style="text-indent: 2em;padding-top:10px;">
			<strong>
				窗口信息结构 NPPILY.Struct.WindowStruct:
			</strong>
		</p>
		<div style="padding-left:25px;padding-top:10px;">
			<table>
				<tr>
					<td>
						变量
					</td>
					<td>
						类型
					</td>
					<td>
						描述
					</td>
				</tr>
				<tr>
					<td class="td_b">
						container
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						窗口容器DOM对象
					</td>
				</tr>
				<tr>
					<td class="td_b">
						containerId
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						窗口容器ID
					</td>
				</tr>
				<tr>
					<td class="td_b">
						wndName
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						窗口插件Name
					</td>
				</tr>
				<tr>
					<td class="td_b">
						wnd
					</td>
					<td>
						Object NOT NULL
					</td>
					<td>
						窗口插件对象
					</td>
				</tr>
				<tr>
					<td class="td_b">
						connectId
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						与服务器连接id
					</td>
				</tr>
				<tr>
					<td class="td_b">
						wndHandle
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						窗口句柄
					</td>
				</tr>
				<tr>
					<td class="td_b">
						type
					</td>
					<td>
						NPPILY.Enum.WindowType NOT NULL
					</td>
					<td>
						窗口类型
					</td>
				</tr>
				<tr>
					<td class="td_b">
						params
					</td>
					<td>
						Object
					</td>
					<td>
						相关视频参数
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">puid</div>
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						设备PUID
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">idx</div>
					</td>
					<td>
						String NOT NULL
					</td>
					<td>
						视频资源索引
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">streamType</div>
					</td>
					<td>
						NPPILY.Enum.NrcapStreamType NOT NULL
					</td>
					<td>
						流类型
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">ivStreamHandle</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						视频流句柄
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">iaStreamHandle</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						音频流句柄
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">alg</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						平台转码流编码算法
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">resolution</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						平台转码流分辨率
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">bitRate</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						平台转码流码率
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">frameRate</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						平台转码流帧率
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">speed</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播速度
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">startTime</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播开始时间
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">endTime</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播结束时间
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">fileFullPath</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播文件全路径
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">fileTimeLength</div>
					</td>
					<td>
						String NULL
					</td>
					<td>
						点播文件时长
					</td>
				</tr>
				<tr>
					<td class="td_b">
						status
					</td>
					<td>
						Object
					</td>
					<td>
						视频窗口状态
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">isddrawing</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否使用了ddraw模式
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">recording</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否在本地录像
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">playaudioing</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否在播放音频
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">playvideoing</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否在播放视频
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">playvoding</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						是否在点播录像
					</td>
				</tr>
				<tr>
					<td class="td_b">
						<div style="padding-left:40px">isfullscreening</div>
					</td>
					<td>
						Bool NULL FALSE
					</td>
					<td>
						视频窗口是否在全屏
					</td>
				</tr>
				<tr>
					<td class="td_b">
						customParams
					</td>
					<td>
						Object NULL
					</td>
					<td>
						自定义参数
					</td>
				</tr>
				<tr>
					<td class="td_b">
						style
					</td>
					<td>
						Object
					</td>
					<td>
						窗口样式<span style="color:red">(未启用)</span>
					</td>
				</tr>
			</table>
		</div>		
		<p style="text-indent: 2em;padding-top:10px;">
			<strong>
				示例：
			</strong>
		</p>





	<div id='center' style='height: 100%;width: 100%;'></div>



	<p style="text-indent: 2em;padding-top:10px;">
			<strong>
				JavaScript源码：
			</strong>
		</p>
		<div style="padding-left:25px;padding-top:10px;overflow:auto;">
			<pre id="preCode" style="border:0px grey solid;width:790px;">
			<code>
	//查询有存储文件的日期：
	var queryConditions ={
		csuPuid: PU.csuPuid,
		puid: WebClient.puid,
		ivIndex: 0,
		streamType: 'REALTIME|STORAGE|MOBILE2G|MOBILE3G|TRANSCODE|HD',	//类型：如果是查询图片则为PICTURE
		offset: 0,
		count: 200
	};
	var operator = NPPILY.FetchCSUIVDate(connectId,queryConditions);

	//查询指定日期中的文件
	var queryConditions ={
		csuPuid: PU.csuPuid,
		puid : WebClient.puid,
		ivIndex: 0,
		datetime: UTC,			//以UTC时间（如1385380100）查询，必选，应该为通过NPPILY.FetchCSUIVDate获取到的UTC日期时间
		streamType: 'REALTIME|STORAGE|MOBILE2G|MOBILE3G|TRANSCODE|HD',  //类型：如果是查询图片则为PICTURE
		offset: 0,
		count: 200
	};
	var operator = NPPILY.FetchCSUIVDateFiles(connectId,queryConditions);


	// - 添加窗口事件
	var windowAttachEvent = new NPPILY.Struct.WindowEventStruct();
	windowAttachEvent.lbtn_click.status = true;
	windowAttachEvent.lbtn_click.callback = function() {
		// 鼠标左键单击响应回调函数
	}
	windowAttachEvent.select_rect.status = true;
	windowAttachEvent.select_rect.callback = function() {
		/*鼠标拉选响应回调函数,注意在窗口模式为“框选”时有效，
		  回调时callback(x1, y1, x2,y2)，其中(x1,y1)、(x2,y2)
		  分别代表窗口中框选的左上与右下坐标*/
	}
    // fsw_show.status | fsw_hide.status置为false没有意义，造成全屏黑屏
	windowAttachEvent.fsw_show.status = true;
	windowAttachEvent.fsw_show.callback = function() {
		// 窗口全屏后的回调函数
	}
	windowAttachEvent.fsw_hide.status = true;
	windowAttachEvent.fsw_hide.callback = function() {
		// 窗口全屏恢复后的回调函数
	}
    // 自定义视频窗口右键菜单项
    windowAttachEvent.menu_command.status = true;
    windowAttachEvent.menu_command.menu = [{
        key: "stopvod", text: "停止视频"							
    }, {
        key: "separator", text: "first"							
    }, {
        key: "fullscreen", text: "全屏"		
    }];
    windowAttachEvent.menu_command.callback = function (menukey) {
        // 选择右键菜单项回调，menukey对应上面的key，如menukey == "stopvideo"
    };
	
	// 在播放视频之前，应先调用创建窗口
	var operator = NPPILY.CreateWindow(connectId, windowkey, NPPILY.Enum.WindowType.VIDEO, windowAttachEvent);
	if(operator.rv == NrcapError.NRCAP_SUCCESS) {
    	// wnd为窗口信息，应该记录到NPPILY.WindowContianers中
		var wnd = operator.response;
		// 播放视频
		var options = {
			type:NPPILY.Enum.StorageFileType.Platform,
			csuPuid:PU.csuPuid,
			puid:WebClient.puid,
			fileFullPath:fpath+fname
		};
		var play_operator = NPPILY.PlayVod(connectId, wnd, options);
		if(play_operator.rv == NrcapError.NRCAP_SUCCESS) {
			// 播放成功
		}
	}

	//下载录像或图片
	var create = NPPILY.Folder.CreateDirectory(localSavePath); //创建本地文件夹，localSavePath稳文件夹全路径
	if(create.rv == NrcapError.NRCAP_SUCCESS){
		var exist = NPPILY.Folder.FileExist(localSaveAsfile);  //检测是否已经有此文件，localSaveAsfile为下载后文件的全路径
		if(exist.rv == 0){
			var operator = NPPILY.Download.StartCSUFileDownload(connectId,PU.csuPuid,fileAllPath,localSaveAsfile);  //开始下载，fileAllPath为文件在平台中的存储路径
			if(operator.rv == NrcapError.NRCAP_SUCCESS)
			{
			}else{
				alert("下载失败="+operator.rv);
			}
		}else if(exist.rv == 1){
			alert("文件已存在")
		}
	}
	
	</code>
			</pre>
		</div>
	</div>
</body>

<script type="text/javascript">
	var PU = {
		//csuPuid:"155233901491981411",  // 中心存储器（管理平台存储）
		// csuPuid:"155536161512531454",
		//csuPuid:"155143252562500083",
		csuPuid:"155876181517381909",
		ivIndex: 0, // 摄像头索引，可以查多个摄像头的，查询函数处做处理
		end: true
	}
	var WebClient = {
		connectId : null,
		resource : new NPPUtils.Hash(),
		puid:"",
		style:"",
		idx:"",
		name:"",
		Load:function(){
			try {
				$.browser = {};
				/*$("#vod-replayer-slider").slider('setValue',0);
				$("#vod-replayer-slider").slider({disabled:true});*/
				$("#preCode").snippet("javascript", {style: "acid", collapse: true, startCollapsed: false});
				
				// 首先初始化NPPILY，加载插件
				var operator = NPPILY.Init(new NPPILY.Struct.InitParamStruct(true, function(msg){console.log(msg.fn,msg.msg)}, null));
				if (operator.rv != 0) {
					// 初始化不成功
					alert(NrcapError.Detail(operator.rv));
				}

				/*$(window).resize(function(){
					WebClient.ChangeWinResize();
				})*/

				// 建立连接
				WebClient.Connect();
			}
			catch (e) {
				console.log("excep error -> " + e.name + "::" + e.message);
				return false;
			}
		},

		// - 创建连接，连接信息记录在NPPILY.Connections全局变量中
		Connect: function() {
			var path = _npc.connParams.path || "127.0.0.1:8866";
			var username = _npc.connParams.username || "admin";
			var password = _npc.connParams.password || "";
			var epId = _npc.connParams.epId || "system"; //登陆参数：企业id
			var bfix = _npc.connParams.bfix || 0;
			// 调用建立连接函数
			var operator = NPPILY.Connect
			(
				new NPPILY.Struct.ConnParamStruct
				(
					path,
					username,
					epId,
					password,
					bfix
				)　
			);
			if (operator.rv == 0) {
				// 此即是当前连接ID，记录下来
				WebClient.connectId = operator.response;
				// 注册绑定NC事件回调，平台事件回调通知
				NPPILY.NCNotifyManager.Add(
					NPPILY.Enum.NCObjectNotify.event_notify,
					function (notify) {
						//WebClient.EventNotify(notify);
					}
				);
				
				// 所有的视频状态、喊话对讲、音频状态等信息都是通过流状态回调通知
				var ss = NPPILY.NCNotifyManager.Add(
					NPPILY.Enum.NCObjectNotify.stream_status_notify,
					function (notify) {
					// 更新视频状态回调，等有视频播放的时候就会有调用
					WebClient.UpdateVideoStatus(notify);
					}
				);

				WebClient.CreateQuickQueryVodWin();
			}
		},

		CreateQuickQueryVodWin:function(){
			var html = "";
			html +=	'<div class="" style="float: left;width:100%;">';
			html +=		'<div style="padding-left:25px;padding-top:10px;overflow:auto;border:1px grey solid;">';
			html +=			'<div><input type="button" value="获取资源" onClick="javascript:WebClient.FetchResource();"/></div>';
			html +=			'<div style="float:left;border:1px solid grey;">';
			html +=				'<div id="resourceTree" class="resourceTree" style="height:280px;width:400px;overflow: auto;"></div>';
			html +=				'<div style="text-align:center;">';
			html += 				'<input id="QueryVod" type="button" value="查询录像" style="width:100px;height:25px;cursor:pointer;">';
			html += 				'<input id="QueryPhoto" type="button" value="查询图片" style="width:100px;height:25px;cursor:pointer;">';
			html += 			'</div>';
			html +=			'</div>';
			html +=			'<div style="float:left;">';
			html +=				'<div id="querydate" style="border:1px grey solid;width:200px;height:310px;overflow: auto;margin-left:10px;"></div>';
			html +=			'</div>';
			html +=			'<div style="float: left;">';
			html +=				'<div id="vodwin" class="vodwin" style="border:1px solid grey;width:350px;height: 310px;margin-left:20px;"></div>';
			html +=			'</div>';
			html +=			'<div style="clear:left;">';
			html +=				'<div style="height:10px;"></div>';
			html +=				'<div id="queryfiles" style="border:1px grey solid;width:1200px;height:300px;overflow: auto;">';
			html +=					'<table style="white-space:nowrap;width:100%;font-size:14px;" id="filestable">';
			html +=						'<tr>';
			html +=							'<td class="tb_head">索引</td>';
			html +=							'<td class="tb_head">文件名称</td>';
			html +=							'<td class="tb_head">文件大小</td>';
			html +=							'<td class="tb_head">起始时间</td>';
			html +=							'<td class="tb_head">结束时间</td>';
			html +=							'<td class="tb_head">录像原因</td>';
			html +=							'<td class="tb_head">存储路径</td>';
			html +=							'<td class="tb_head">操作</td>';
			html +=						'</tr>';
			html +=					'</table>';
			html +=				'</div>';
			html +=				'<div style="height:20px;"></div>';
			html +=			'</div>';
			html +=		'</div>';
			html +=	'</div>';
			$("#center").html(html);

			$("#QueryVod").click(function(){
				WebClient.QueryDate();
		    });
		    $("#QueryPhoto").click(function(){
		    	WebClient.QueryPhotoDate();
		    })
		},
		

		FetchResource: function () {
			try {
				var connectId = WebClient.connectId;
				if (!connectId || !NPPILY.Connections.get(connectId)) {
					alert("连接信息不存在，获取资源失败");
					return false;
				}
				var _connStruct = NPPILY.Connections.get(connectId),
					rootName = "",
					resource = [],
					style = "cr",
					offset = 0,
					count = 200,
					html = "",
					rootName = _connStruct.systemName || "网络视频监控系统";
					
					while(true) {
						// 分页获取所有设备资源
						var operator = NPPILY.ForkResource
						(
							connectId,
							NPPILY.Enum.ForkResourceLevel.nppForkPUInfo, //构建类型
							offset,//
							count,//分页查询每次返回的最大条数
							"" // 为空获取根平台的资源 
						);
						if (operator.rv == 0 && operator.response) {
							resource = resource.concat(operator.response);
							
							if (operator.response.length >= count) {
								// 继续获取
								offset = offset + count;
							}
							else {
								break;
							}
						}
						else {
							// 其他错误跳出循环
							break;
						} 
					};
					// 进行在线排序
					var onlines = [], offlines = [];
					$.each(resource, function (index, item) {
						if (item.online == 1 && item.enable == 1) {
							onlines.push(item);
						}
						else {
							offlines.push(item);
						}
					});
					resource = [];
					resource = resource.concat(onlines);
					resource = resource.concat(offlines);
				
				// 记录资源信息
				WebClient.resource.set(connectId, resource);
				
				if ($("#resourceTree")[0]) {
					var lastnode = "",
						idRootPfx = style + '_cesSystemManagement';
					
					html += '<div id="' + idRootPfx + '" style="white-space:nowrap;margin-top:2px !important; margin-top:2px;">';
						html += '<input id="'+idRootPfx+'_img_title" type="button" class="minus" onfocus="this.blur();"  onclick="WebClient.Expandsion($(\'#'+idRootPfx+'_childresourcebox\')[0], $(\'#'+idRootPfx+'_img_title\')[0]);" />';
						html += '<input id="'+idRootPfx+'_img_ico" type="button" class="root" onfocus="this.blur();"  onclick="WebClient.Expandsion($(\'#'+idRootPfx+'_childresourcebox\')[0], $(\'#'+idRootPfx+'_img_title\')[0]);" />'; 
						html += '<label  onclick="WebClient.Expandsion($(\'#'+idRootPfx+'_childresourcebox\')[0],$(\'#'+idRootPfx+'_img_title\')[0]);" title="'+rootName+'">'+rootName+'</label>';
						// html.push('<a href="javascript:void(0);" onclick="WebClient.Expandsion($(\'#'+idRootPfx+'_childresourcebox\')[0], $(\'#'+idRootPfx+'_img_title\')[0]);" title="' + rootName + '">' + rootName + '</a>');
					html += '</div>';
					
					html += '<div id="'+idRootPfx+'_childresourcebox" class="childresourcebox_blankline" style="padding-left:15px;">';
					// 遍历资源
					$.each(resource, function (index, item) {
						var prefix = "station", suffix = "_disabled", idPfx = style + "_" + item.puid;
						if (_connStruct.connType == NPPILY.Enum.ConnectionType.Server) {
							switch (item.modelType) {
								case NPPILY.Enum.PuModelType.ENC:
									prefix = "station";
									break;
								case NPPILY.Enum.PuModelType.WENC:
									prefix = "gateway";
									break;
								default:
									return true;
									break;
							}
						}
						
						if (item.online == 1 && item.enable == 1) {
							suffix = "";
						}
						var clsname = prefix + "" + suffix;
						
						html += '<div style="white-space:nowrap;">';
							html += '<input id="'+idPfx+'_img_title" type="button" class="plus" onfocus="this.blur();" onclick="WebClient.FetchChildResource(\'' + item.puid + '\', \'' + style + '\');" />';
							html += '<input id="'+idPfx+'_img_ico" type="button" class="'+clsname+'" onfocus="this.blur();" onclick="WebClient.FetchChildResource(\'' + item.puid + '\', \'' + style + '\');" />';
							html += '<label  onclick="WebClient.FetchChildResource(\'' + item.puid + '\', \'' + style + '\');" title="'+item.name+'">'+item.name+'</label>';
						html += '</div>';
						html += '<div id="'+idPfx+'_childresourcebox" class="childresourcebox_directline" style="height:auto;display:none;padding-left:15px;">';
						html += '</div>';
						
						lastnode = idPfx + '_childresourcebox';
					});
					if (resource.length <= 0) {
						html += '<div style="font-style:italic;">（无设备资源）</div>';
					}

					html += '</div>';
					
					$("#resourceTree")
						.html(html)
						.find("#" + lastnode)
						.attr("class", "childresourcebox_blankline");
				}
			}
			catch (e) {
				alert("excep error -> " + e.name + "::" + e.message);
				return false;
			}
		},
						
		FetchChildResource: function (puid, style) {
			try {
				var idPfx = style + "_" + puid,
					idChildresbox = idPfx + "_childresourcebox",
					idPUTitle = idPfx + "_img_title";
				
				var connectId = WebClient.connectId;
				if (!connectId || !NPPILY.Connections.get(connectId)) {
					alert("连接信息不存在，获取资源失败");
					return false;
				}
				var _connStruct = NPPILY.Connections.get(connectId);
				
				if ($("#" + idChildresbox)[0]) {
					if ($("#" + idChildresbox).html() == "") {
						// 是否存在相关子资源信息
						var puInfo, puChildres = [];
						$.each(WebClient.resource.get(connectId), function(index, item) {
							if (item.puid == puid) {
								puInfo = item;
								puChildres = item.childResource || [];
								return false;
							}
						});
						// 为空就去获取子资源信息
						if (!puChildres || puChildres.length <= 0) {
							var operator = NPPILY.ForkResource
							(
								connectId,
								NPPILY.Enum.ForkResourceLevel.nppForkPUResourceInfo,
								null,
								null,
								null,
								{
									PUID: puid
								}
							);
							if (operator.rv == 0) {
								puChildres = operator.response;
							}
						}
						
						var html = "",
							lastnode = "";
						
						if (puInfo && puChildres && puChildres.length > 0) {
							$.each(puChildres, function (index, item) {     
								var prefix = "inputvideo", suffix = "";
								
								if (item.type != NPPILY.Enum.PuResourceType.VideoIn) {
									return true;
								}
								
								if (puInfo.online == 0 || puInfo.enable == 0 || item.enable == 0) {
									suffix = "_disabled";
								}
								
								var clsname = prefix + "" + suffix;	
								
								var idChildPfx = idPfx + "_" + item.type + "_" + item.idx;
								
								html += '<div style="white-space:nowrap;">';
									html += '<input id="'+idChildPfx+'_img_title" mark="childEle" Puid="'+ puid +'" Idx="'+item.idx+'" ResourcesType="'+style+'" Name="'+item.name+'" type="button" class="outline" onfocus="this.blur();"/>';
									html += '<input id="'+idChildPfx+'_img_ico" mark="childEle" Puid="'+ puid +'" Idx="'+item.idx+'" ResourcesType="'+style+'" Name="'+item.name+'" type="button" class="'+clsname+'" onfocus="this.blur();"/>';
									html += '<label  mark="childEle" Puid="'+ puid +'" Idx="'+item.idx+'" ResourcesType="'+style+'" Name="'+item.name+'" title="'+item.name+'">'+item.name+'</label>';
									/*html += '<input id="'+idChildPfx+'_img_title" mark="childEle" Puid="'+ puid +'" Idx="'+item.idx+'" ResourcesType="'+style+'" Name="'+item.name+'" type="button" class="outline" onfocus="this.blur();" onclick="WebClient.treeCallBack(\'' + puid + '\',\'' + item.idx + '\',\'' + style + '\',\'' + item.name + '\');" />';
									html += '<input id="'+idChildPfx+'_img_ico" mark="childEle" type="button" class="'+clsname+'" onfocus="this.blur();" onclick="WebClient.treeCallBack(\'' + puid + '\',\'' + item.idx + '\',\'' + style + '\',\'' + item.name + '\');" />';
									html += '<label  mark="childEle" onclick="WebClient.treeCallBack(\'' + puid + '\',\'' + item.idx + '\',\'' + style + '\',\'' + item.name + '\');" title="'+item.name+'">'+item.name+'</label>';*/
								html += '</div>';
								
								lastnode = idChildPfx + "_img_title";
							});
						}
						else {
							html += '<div style="font-style:italic;">（无视频资源）</div>';
						}
						
						$("#" + idChildresbox)
							.html(html)
							.find("#" + lastnode)
							.attr("class", "endline");

						$("label[mark='childEle']").click(function(){
							WebClient.puid = $(this).attr("Puid");
							WebClient.idx = $(this).attr("Idx");
							WebClient.style = $(this).attr("ResourcesType");
							WebClient.name = $(this).attr("Name");
						})
			
					} // end if html()
					
					WebClient.Expandsion($("#" + idChildresbox)[0], $("#" + idPUTitle)[0]);
				} 
			}
			catch (e) {
				alert("excep error -> " + e.name + "::" + e.message);
				return false;
			}
		},


		//获取平台存储下有存储文件的日期
		QueryDate: function() {
			var connectId = WebClient.connectId;
			var queryConditions ={
				csuPuid: PU.csuPuid,
				puid: WebClient.puid,
				ivIndex: 0,
				streamType: 'REALTIME|STORAGE|MOBILE2G|MOBILE3G|TRANSCODE|HD',
				offset: 0,
				count: 200
			};
			
			var operator = NPPILY.FetchCSUIVDate(connectId,queryConditions);
			
			if (operator.rv == NrcapError.NRCAP_SUCCESS){
				
				var datefiles = operator.response;
				var html = "",
					lastnode = "";
				if( datefiles && datefiles.length > 0) {
					for(i=0;i<datefiles.length;i++){
						var dt = new Date(parseInt(datefiles[i])* 1000);
						var dtname = NPPUtils.DateFormat("yyyy-MM-dd",dt);
						var UTC = datefiles[i];
						html += '<div style="white-space:nowrap;">';
							html += '<label style="cursor:default;" onclick="WebClient.QueryDateFiles(\'' + UTC + '\');">'+dtname+'</label>';
						html += '</div>';
					}
				}
				else {
						html += '<div style="font-style:italic;">（无视频存储资源）</div>';
				}

				$("#querydate")
					.html(html)
					.attr("class", "date");			
			}
		},
		

		//按日期获取视频的平台存储文件
		QueryDateFiles: function (UTC) {
			$(".childfiles").html("");
			var connectId = WebClient.connectId;
			var queryConditions ={
				csuPuid: PU.csuPuid,
				puid : WebClient.puid,
				ivIndex: 0,
				datetime: UTC,
				streamType: 'REALTIME|STORAGE|MOBILE2G|MOBILE3G|TRANSCODE|HD',
				offset: 0,
				count: 200
			};

			var operator = NPPILY.FetchCSUIVDateFiles(connectId,queryConditions);
			if (operator.rv == NrcapError.NRCAP_SUCCESS){
				var datefiles = operator.response;
				
				var childhtml = [],
					childlast = "";
				
				
				
				if( datefiles && datefiles.length > 0) {
					for(i=0;i<datefiles.length;i++){
						var htmlstr ="";

						var index = i+1,
							fname = datefiles[i].fileName,
							fs = (datefiles[i].fileSize/1000000).toFixed(2),
							fsize = fs+"M",
							fbt = new Date(parseInt(datefiles[i].beginTime*1000)),
							fbgtime = NPPUtils.DateFormat("yyyy-MM-dd hh:mm:ss",fbt),
							fet = new Date(parseInt(datefiles[i].endTime*1000)),
							fendtime = NPPUtils.DateFormat("yyyy-MM-dd hh:mm:ss",fet),
							freason = datefiles[i].reason,
							fpath = datefiles[i].filePath;
						childhtml.push('<tr style="white-space:nowrap;cursor:default;" class="childfiles" onmouseover="WebClient.Over(\'' + i + '\')" onmouseout="WebClient.Out(\'' + i + '\')"  >');
							childhtml.push('<td class="inx">'+index+'</td>');
							childhtml.push('<td>'+fname+'</td>');
							childhtml.push('<td>'+fsize+'</td>');
							childhtml.push('<td>'+fbgtime+'</td>');
							childhtml.push('<td>'+fendtime+'</td>');
							childhtml.push('<td>'+freason+'</td>');
							childhtml.push('<td>'+fpath+'</td>');
							childhtml.push('<td>'+'<a onClick = "WebClient.QueryPlay(\'' + fpath + '\',\'' + fname + '\')">'+"播放"+'</a>'+' '+'<a id=\"startdownloadvod_btn_"+i+"\" onClick="WebClient.QueryDownload(\'' + fpath + '\',\'' + fname + '\',\'' + "vod" + '\')">'+"下载"+'</a>'+'</td>');
						childhtml.push('</tr>');
					}
				}
				else {
						childhtml.push('<div style="font-style:italic;">（无视频存储资源）</div>');
				}
				

				$("#filestable")
					.html(childhtml.join(""));
					
				
				$("#filestable").prepend(
					"<tr><td class='tb_head'>索引</td><td class='tb_head'>文件名称</td><td class='tb_head'>文件大小</td><td class='tb_head'>起始时间</td><td class='tb_head'>结束时间</td><td class='tb_head'>录像原因</td><td class='tb_head'>存储路径</td><td class='tb_head'>操作</td></tr>"
				);
				
			}
		},

		QueryPlay: function (fpath,fname){
			if(WebClient && WebClient.wnd){
				WebClient.QueryStop();
			}
			if($("vodwin[0]")){
				/*var connectId = WebClient.connectId;
				
				var windowObj = NPPILY.CreateWindow(connectId, "vodwin", "VOD");
				var wnd = windowObj.response;  //窗口信息
				WebClient.wnd = wnd;
				var options = {
					type:NPPILY.Enum.StorageFileType.Platform,
					csuPuid:PU.csuPuid,
					puid:WebClient.puid,
					fileFullPath:fpath+fname
				};
				var operator = NPPILY.PlayVod(
					connectId,
					wnd,
					options
				);
				if(operator.rv == NrcapError.NRCAP_SUCCESS){
				}else{
					alert("点播失败："+operator.rv);
				}*/

				var connectId = WebClient.connectId;
				if(connectId){

					var winevt = new NPPILY.Struct.WindowEventStruct();
					// 单击事件
					winevt.lbtn_click.status = true;
					// 视频窗口（退出）全屏回调
					winevt.fsw_show.callback = winevt.fsw_hide.callback = function () {
						WebClient.BackFullScreen();
					};
					// 窗口内云台控制允许
					winevt.ptz_control.status = true;
					// 右键菜单
					winevt.menu_command.status = true;
					winevt.menu_command.menu = [{
						key: "stopvod", text: "停止视频"							
					}];
					winevt.menu_command.callback = function (key) {
						switch(key){
							case "stopvod":
								WebClient.QueryStop();
								break;
						}
					};

					
					var windowObj = NPPILY.CreateWindow(connectId, "vodwin", "VOD", winevt);
					var wnd = windowObj.response;  //窗口信息
					WebClient.wnd = wnd;
					var options = {
						type:NPPILY.Enum.StorageFileType.Platform,
						csuPuid:PU.csuPuid,
						puid:WebClient.puid,
						fileFullPath:fpath+fname
					};
					var operator = NPPILY.PlayVod(
						connectId,
						wnd,
						options
					);

					if(operator.rv == NrcapError.NRCAP_SUCCESS){
					}else{
						alert("点播失败："+operator.rv);
					}

					/*console.log("s1")
					var windowAttachEvent = new NPPILY.Struct.WindowEventStruct();
					console.log("s2")
					windowAttachEvent.menu_command.status = true;
					console.log("s3")
					windowAttachEvent.menu_command.menu = "";
					console.log("s4")

					var customMenus = [{key:"stopvod",text:"停止播放"},{key:"-",text:"split"}];
					console.log("s5")
					var menus = NPPILY.WindowAttachEvent.AppendMenuCommand(wnd,customMenus);
					console.log("s6")
					menus.menu_command.callback = function(key){
						console.log("s7")
						switch(key){
							case "stopvod":
								WebClient.QueryStop();
								break;
							case "playvodaudio":
								WebClient.playvodaudio();
								break;
						}
					}
					console.log("s")*/
				}
			}
		},

		// 响应（退出）全屏事件
		BackFullScreen: function () {
			try {
				var node = NPPILY.WindowContainers.get("vodwin");
				if (node && node.window) {
					var customMenus = [];
					if (node.window.status.isfullscreening) {
						customMenus.push({key: "fullscreen", text: "退出全屏"});
					}
					else {
						customMenus.push({key: "fullscreen", text: "全屏"});
					}
					// 更新菜单项
					NPPILY.WindowAttachEvent.UpdateMenuCommand(node.window, customMenus);
				}
			}
			catch (e) {
				alert("excep error = " + e.name + "::" + e.message);
				return false;
			}
		},

		QueryStop:function(){
			var wnd = WebClient.wnd;
			if(typeof wnd != "object"){
				return false;
			}
			if(wnd == null){
				return false;
			}
			if(wnd.containerId == "vodwin"){
				if(wnd.status.playvoding){
					var rv = NPPILY.StopVod(wnd);
					if(rv.rv == NrcapError.NRCAP_SUCCESS){
						$("#vodwin")[0].innerHTML = "";
						wnd.wnd.style.height = "0px"
						wnd.wnd.style.width = "0px"
					}	
				}
			}
		},

		QueryDownload:function(fpath,fname,ftype){
			var localSavePath = "";
			var localSaveAsfile = "";
			if(ftype == "vod"){
				localSavePath = "C:/WebSDK/Download_vod/";		//本地文件夹路径
				localSaveAsfile = "C:/WebSDK/Download_vod/"+fname;		//下载图片的本地存储路径
			}else if(ftype == "photo"){
				localSavePath = "C:/WebSDK/Download_photo/";
				localSaveAsfile = "C:/WebSDK/Download_photo/"+fname;
			}
			var create = NPPILY.Folder.CreateDirectory(localSavePath); //创建本地文件夹
			if(create.rv!= NrcapError.NRCAP_SUCCESS||create.response!=0){
				WebClient.CheckFolderPermission();
				return false;
			}else{
			    var exist = NPPILY.Folder.FileExist(localSaveAsfile);
				if(exist.rv == 0){
					var fileAllPath  = fpath+fname;
					var connectId = WebClient.connectId;
					var operator = NPPILY.Download.StartCSUFileDownload(connectId,PU.csuPuid,fileAllPath,localSaveAsfile);
					var _handle = operator.response;
					if(operator.rv == NrcapError.NRCAP_SUCCESS)
					{
						//WebClient.GetDownStatus(id);
						NPPILY.NCNotifyManager.Add(NPPILY.Enum.NCObjectNotify.stream_status_notify,WebClient.SetStatus);
					}else{
						alert("下载失败="+operator.rv);
					}
				}else if(exist.rv == 1){
					alert("文件已存在")
				}
			}
		},
        
		CheckFolderPermission:function(){
		    if(CRWebClient.Brower&&CRWebClient.Browser.IE){
			    var testFolder='C:/';
				if(typeof Globals.localstorage!='undefined'){
				     testFolder=Globals.localstorage.snapshot;
				}
				var testFileName=testFolder+'/'+('__cr_chk_xxx_'+new Date().getTime())+'.txt';
				
				var operator=NPPILY.Folder.GetFileJurisdiction(testFileName);
				var has;
				if(operator.rv!=NrcapError.NRCAP_SUCCESS){
				    has=false;
				}else{
				    if(operator.response==-1){
					    has=false;
					}
				}
				if(has!=true){
				    var msgBody=noPermission;
					if(CRWebClient.Brower&&CRWebClient.Browser.IE){
					    msgBody=noPermissionIE;
						alert("IE浏览器未加信任站点，请点击Internet选项设置信任站点");
					}
				}
			}
		},
        
		//获取平台存储下有存储文件的日期(照片)
		QueryPhotoDate: function() {
			var connectId = WebClient.connectId;
			var queryConditions ={
				csuPuid: PU.csuPuid,
				puid: WebClient.puid,
				ivIndex: 0,
				streamType: 'PICTURE',
				offset: 0,
				count: 200
			};
			
			var operator = NPPILY.FetchCSUIVDate(connectId,queryConditions);
			
			if (operator.rv == NrcapError.NRCAP_SUCCESS){
				
				var datefiles = operator.response;
				var html = "",
					lastnode = "";
				if( datefiles && datefiles.length > 0) {
					for(i=0;i<datefiles.length;i++){
						var dt = new Date(parseInt(datefiles[i])* 1000);
						var dtname = NPPUtils.DateFormat("yyyy-MM-dd",dt);
						var UTC = datefiles[i];
						html += '<div style="white-space:nowrap;">';
							html += '<label style="cursor:default;" onclick="WebClient.QueryPhotoDateFiles(\'' + UTC + '\');">'+dtname+'</label>';
						html += '</div>';
					}
				}
				else {
						html += '<div style="font-style:italic;">（无图片存储资源）</div>';
				}

				$("#querydate")
					.html(html)
					.attr("class", "date");			
			}
		},
		

		//按日期获取视频的平台存储文件
		QueryPhotoDateFiles: function (UTC) {
			$(".childfiles").html("");
			var connectId = WebClient.connectId;
			var queryConditions ={
				csuPuid: PU.csuPuid,
				puid : WebClient.puid,
				ivIndex: 0,
				datetime: UTC,
				streamType: 'PICTURE',
				offset: 0,
				count: 200
			};

			var operator = NPPILY.FetchCSUIVDateFiles(connectId,queryConditions);
			if (operator.rv == NrcapError.NRCAP_SUCCESS){
				var datefiles = operator.response;
				
				var childhtml = [],
					childlast = "";
				
				
				
				if( datefiles && datefiles.length > 0) {
					console.log(datefiles)
					for(i=0;i<datefiles.length;i++){
						var htmlstr ="";

						var index = i+1,
							fname = datefiles[i].fileName,
							fs = (datefiles[i].fileSize/1000000).toFixed(2),
							fsize = fs+"M",
							fbt = new Date(parseInt(datefiles[i].beginTime*1000)),
							fbgtime = NPPUtils.DateFormat("yyyy-MM-dd hh:mm:ss",fbt),
							fet = new Date(parseInt(datefiles[i].endTime*1000)),
							fendtime = NPPUtils.DateFormat("yyyy-MM-dd hh:mm:ss",fet),
							freason = datefiles[i].reason,
							fpath = datefiles[i].filePath;							
						
						childhtml.push('<tr style="white-space:nowrap;cursor:default;" class="childfiles" onmouseover="WebClient.Over(\'' + i + '\')" onmouseout="WebClient.Out(\'' + i + '\')"  >');
							childhtml.push('<td class="inx">'+index+'</td>');
							childhtml.push('<td>'+fname+'</td>');
							childhtml.push('<td>'+fsize+'</td>');
							childhtml.push('<td>'+fbgtime+'</td>');
							childhtml.push('<td>'+fendtime+'</td>');
							childhtml.push('<td>'+freason+'</td>');
							childhtml.push('<td>'+fpath+'</td>');
							childhtml.push('<td>'+'<a id=\"startdownloadvod_btn_"+i+"\" onClick="WebClient.QueryDownload(\'' + fpath + '\',\'' + fname + '\',\'' + "photo" + '\')">'+"下载"+'</a>'+'</td>');
						childhtml.push('</tr>');
					}
				}
				else {
						childhtml.push('<div style="font-style:italic;">（无视频存储资源）</div>');
				}
				

				$("#filestable")
					.html(childhtml.join(""));
					
				
				$("#filestable").prepend(
					"<tr><td class='tb_head'>索引</td><td class='tb_head'>文件名称</td><td class='tb_head'>文件大小</td><td class='tb_head'>起始时间</td><td class='tb_head'>结束时间</td><td class='tb_head'>录像原因</td><td class='tb_head'>存储路径</td><td class='tb_head'>操作</td></tr>"
				);
				
			}
		},

		LookOverPhoto:function(fpath,fname){
			var localSaveAsfile = "Download_photo/"+fname;
			var fileAllPath  = fpath+fname;
			var connectId = WebClient.connectId;
			var operator = NPPILY.Download.StartCSUFileDownload(connectId,PU.csuPuid,fileAllPath,localSaveAsfile);
			if(operator.rv == NrcapError.NRCAP_SUCCESS)
			{
				var html = "<img src='"+localSaveAsfile+"' />";
				$("#vodwin").html(html);
			}else{
				alert("下载失败="+operator.rv);
			}
		},

		//控制资源列表显示和隐藏
		Expandsion: function (obj, title, ico) {
			if (obj) {
				if (obj.style.display == "none") {
					if (obj.innerHTML == "") return;
					obj.style.display = "block";
					if (title) title.className = "minus";
					if (ico) {
						ico.className = "stationmodel_expand";
					}
				}
				else {
					obj.style.display = "none";
					if (title) title.className = "plus";
					if (ico) {
						ico.className = "stationmodel_collapse";
					}
				}
			}
		},
		

		// 更新显示视频状态信息
		UpdateVideoStatus: function (notify) {
			try {
				if (notify && notify._HANDLE) {
					NPPILY.WindowContainers.each(function (item) {
						var node = item.value;
						if (node.window && node.window.status.playvideoing) {
							// 根据句柄匹配
							if (node.window.params.ivStreamHandle == notify._HANDLE) {
								 if (notify.errorCode == 0) {
									var html = [];
									// 视频名称
									html.push(node.window.customParams.ivName);
									if (typeof notify.statusDesc != "undefined" && notify.statusDesc != "") {
										html.push("&nbsp;");
										html.push(notify.statusDesc);
									}
									html.push(",帧率=" + (notify.keyData.frame_rate || 0));
									html.push(",码率=" + ((notify.keyData.bit_rate || 0)/1000).toFixed(0) + "kb");
									
									if (node.window.status.playaudioing) {
										html.push(",正在播放声音");
									}
									if (node.window.status.recording) {
										html.push(",正在录像");
									}
									// 是否有喊话对讲
									var oaStatus_operator = NPPILY.CallTalkControl.GetStatus(WebClient.connectId, node.window.params.puid, 0);
									if (oaStatus_operator.rv == 0) {
										var oaStatus = oaStatus_operator.response;
										if (oaStatus && oaStatus.oaStreamHandle) {
											html.push(",正在" + (oaStatus.call ? "喊话" : "对讲"));
										}
									}
									
									$("#windowtitle")
										.html(html.join(""))
										.attr("title", html.join("").replace(/(\&nbsp;)/gm, ""));

									// 流断开，需要断线重连播放视频处理
									if (notify.status == -1) {
										
										var ivparams = node.window.params;
										
										WebClient.StreamBreakRestore.Register({
											type: 'VIDEO',
											winkey: 'windowbox',
											puid: ivparams.puid,
											ivIndex: ivparams.idx,
											streamType: ivparams.streamType,
											customParams: node.window.customParams
										});
									}
									
								} // end errorCode
							}
						}
					});
				}
			}
			catch (e) {
				return false;
			}
		},
		
		// 流断线重连处理
		StreamBreakRestore: {
			store: null,
			
			interval: 1000,
			
			Run: function () {
				try {
					// 启动定时器
					NPPUtils.Timer.Start();
					NPPUtils.Timer.Set('websdk', {
						name: 'stream-break-restore',
						fu: function () {
							WebClient.StreamBreakRestore.Call();
						},
						interval: this.interval
					});
				}
				catch (e) {
					return false;
				}
			},
			
			Register: function (options) {
				try {
					if (this.store == null) {
						this.store = new NPPUtils.Hash();
					}
					
					if (options.winkey) {
						this.store.set(options.winkey, {
							type: options.type,
							params: options,
							time: parseInt(new Date().getTime()/1000)
						});
					}
					
					this.Run();
				}
				catch (e) {
					return false;
				}
			},
			
			UnRegister: function (key) {
				try {
					this.store.unset(key);
				}
				catch (e) {
					return false;
				}
			},
			
			Call: function () {
				try {
					var SELF = WebClient.StreamBreakRestore;
					
					SELF.store.each(function (item) {
						var isRestored = false;
						switch (item.value.type) {
						case 'VIDEO':
							isRestored = SELF.RestoreVideo(item.value.params);
							break;
						default:
							break;
						}
						if (isRestored) {
							SELF.UnRegister(item.key);
						}
					}); 
				}
				catch (e) {
					return false;
				}
			},
			
			// 尝试恢复视频播放
			RestoreVideo: function (params) {
				try {
					// 获取视频窗口对象
					var node = NPPILY.WindowContainers.get(params.winkey);
					if (node.window) {
						// 此窗口有正在播放的要停止掉
						if (node.window.status.playvideoing) {
							// 把设备的喊话对讲先给停止了
							NPPILY.CallTalkControl.Stop(WebClient.connectId, params.puid, 0);
							// 更新喊话对讲按钮状态
							WebClient.UpdateCallTalkButtonStatus();
							
							// 然后停止视频
							NPPILY.StopVideo(node.window);
						}
						
						var cp = params.customParams || {};
						var tip = cp.ivName + ' 流已断开，正在尝试恢复播放中...'
						jQuery('#windowtitle').html(tip);
						
						// 尝试播放
						var operator = NPPILY.PlayVideo
						(
							WebClient.connectId,
							node.window,
							params.puid,
							params.ivIndex,
							params.streamType
						);
						
						// 播放成功
						if (operator.rv == 0) {

							// 把视频插件宽高置为100%自适应窗口容器
							NPPILY.ResizeWindowDimension(node.window, "100%", "100%");
							
							return true;
						}
					}

					return false;
				}
				catch (e) {
					return false;
				}
			},
			
			end: true
		},





		Over:function(i){
			var a = $(".childfiles");
			a.eq(i).css("background-color","#FFFFA5");
		},

		Out:function(i){
			var a = $(".childfiles");
			a.eq(i).css("background-color","white");
		},



		// - 卸载插件
		UnLoad:function() {
			WebClient.QueryStop();
			NPPILY.UnLoad();
		},
		end:true
	}

	// 页面加载
	$(document).ready(function () {
		WebClient.Load();
	});
	//页面刷新和关闭
	$(window).unload(function () {
		WebClient.UnLoad();
	});
	if (window.attachEvent) {
		window.attachEvent(
			"onbeforeunload",
			function() {
				WebClient.UnLoad(); 
			}
		);
	}
	else {
		window.addEventListener (
	        "beforeunload",
	        function() {
	             WebClient.UnLoad();
	        },
	        false
	    );
	}
</script>
</html>